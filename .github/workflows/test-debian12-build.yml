name: Test Debian 12 Hardened and Minimal Builds

# Manual trigger only for testing
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PACKER_LOG: "1"

jobs:
  build-hardened-apache:
    name: Build Hardened Apache
    runs-on: self-hosted
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_hardened_apache_only.proxmox-clone.debian_12_hardened_apache" . || true

      - name: Build Hardened Apache Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building hardened Apache from base template..."
          packer build -timestamp-ui -only="debian_12_hardened_apache_only.proxmox-clone.debian_12_hardened_apache" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-hardened-apache
          path: builds/proxmox/linux/debian/12/hardened/packer-*.log
          retention-days: 7

  build-minimal-apache:
    name: Build Minimal Apache
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-hardened-apache
    if: always()

    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_minimal_apache_only.proxmox-clone.debian_12_minimal_apache" . || true

      - name: Build Minimal Apache Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building minimal Apache from base template..."
          packer build -timestamp-ui -only="debian_12_minimal_apache_only.proxmox-clone.debian_12_minimal_apache" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-minimal-apache
          path: builds/proxmox/linux/debian/12/minimal/packer-*.log
          retention-days: 7

  build-hardened-docker:
    name: Build Hardened Docker
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-minimal-apache
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_hardened_docker_only.proxmox-clone.debian_12_hardened_docker" . || true

      - name: Build Hardened Docker Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building hardened Docker from base template..."
          packer build -timestamp-ui -only="debian_12_hardened_docker_only.proxmox-clone.debian_12_hardened_docker" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-hardened-docker
          path: builds/proxmox/linux/debian/12/hardened/packer-*.log
          retention-days: 7

  build-minimal-docker:
    name: Build Minimal Docker
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-hardened-docker
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_minimal_docker_only.proxmox-clone.debian_12_minimal_docker" . || true

      - name: Build Minimal Docker Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building minimal Docker from base template..."
          packer build -timestamp-ui -only="debian_12_minimal_docker_only.proxmox-clone.debian_12_minimal_docker" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-minimal-docker
          path: builds/proxmox/linux/debian/12/minimal/packer-*.log
          retention-days: 7

  build-hardened-mysql:
    name: Build Hardened MySQL
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-minimal-docker
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_hardened_mysql_only.proxmox-clone.debian_12_hardened_mysql" . || true

      - name: Build Hardened MySQL Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building hardened MySQL from base template..."
          packer build -timestamp-ui -only="debian_12_hardened_mysql_only.proxmox-clone.debian_12_hardened_mysql" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-hardened-mysql
          path: builds/proxmox/linux/debian/12/hardened/packer-*.log
          retention-days: 7

  build-minimal-mysql:
    name: Build Minimal MySQL
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-hardened-mysql
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_minimal_mysql_only.proxmox-clone.debian_12_minimal_mysql" . || true

      - name: Build Minimal MySQL Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building minimal MySQL from base template..."
          packer build -timestamp-ui -only="debian_12_minimal_mysql_only.proxmox-clone.debian_12_minimal_mysql" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-minimal-mysql
          path: builds/proxmox/linux/debian/12/minimal/packer-*.log
          retention-days: 7

  build-hardened-tomcat:
    name: Build Hardened Tomcat
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-minimal-mysql
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_hardened_tomcat_only.proxmox-clone.debian_12_hardened_tomcat" . || true

      - name: Build Hardened Tomcat Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/hardened
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building hardened Tomcat from base template..."
          packer build -timestamp-ui -only="debian_12_hardened_tomcat_only.proxmox-clone.debian_12_hardened_tomcat" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/hardened
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-hardened-tomcat
          path: builds/proxmox/linux/debian/12/hardened/packer-*.log
          retention-days: 7

  build-minimal-tomcat:
    name: Build Minimal Tomcat
    runs-on: self-hosted
    timeout-minutes: 60
    needs: build-hardened-tomcat
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: packer init .

      - name: Validate Packer configuration
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: packer validate -only="debian_12_minimal_tomcat_only.proxmox-clone.debian_12_minimal_tomcat" . || true

      - name: Build Minimal Tomcat Template
        id: build
        continue-on-error: true
        working-directory: builds/proxmox/linux/debian/12/minimal
        env:
          PKR_VAR_proxmox_host: ${{ secrets.PROXMOX_HOST }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
          PKR_VAR_node: ${{ secrets.PROXMOX_NODE }}
          PKR_VAR_pool: ${{ secrets.PROXMOX_POOL }}
          PKR_VAR_disk_storage_pool: ${{ secrets.PROXMOX_DISK_STORAGE }}
        run: |
          echo "Building minimal Tomcat from base template..."
          packer build -timestamp-ui -only="debian_12_minimal_tomcat_only.proxmox-clone.debian_12_minimal_tomcat" . 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}

      - name: Check build result
        if: steps.build.outcome == 'failure'
        working-directory: builds/proxmox/linux/debian/12/minimal
        run: |
          if grep -q "VM .* already exists" build.log || grep -q "unable to create VM.*already exists" build.log; then
            echo "VM ID already exists - treating as success"
            exit 0
          else
            echo "Build failed for reason other than VM ID conflict"
            exit 1
          fi

      - name: Upload Packer logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-minimal-tomcat
          path: builds/proxmox/linux/debian/12/minimal/packer-*.log
          retention-days: 7

  build-summary:
    name: Build Summary
    runs-on: self-hosted
    needs: [build-hardened-apache, build-minimal-apache, build-hardened-docker, build-minimal-docker, build-hardened-mysql, build-minimal-mysql, build-hardened-tomcat, build-minimal-tomcat]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## Debian 12 Sequential Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Hardened Builds:" >> $GITHUB_STEP_SUMMARY
          echo "- **Hardened Apache (VM 9001)**: ${{ needs.build-hardened-apache.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hardened Docker (VM 9002)**: ${{ needs.build-hardened-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hardened MySQL (VM 9003)**: ${{ needs.build-hardened-mysql.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Hardened Tomcat (VM 9004)**: ${{ needs.build-hardened-tomcat.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Minimal Builds:" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimal Apache (VM 9005)**: ${{ needs.build-minimal-apache.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimal Docker (VM 9006)**: ${{ needs.build-minimal-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimal MySQL (VM 9007)**: ${{ needs.build-minimal-mysql.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimal Tomcat (VM 9008)**: ${{ needs.build-minimal-tomcat.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Templates Created:" >> $GITHUB_STEP_SUMMARY
          echo "All builds executed sequentially from base template (VM 9000)." >> $GITHUB_STEP_SUMMARY
          echo "- **Hardened** variants include security-focused configurations" >> $GITHUB_STEP_SUMMARY
          echo "- **Minimal** variants optimized for resource efficiency" >> $GITHUB_STEP_SUMMARY

  autofix-ci:
    name: Autofix CI Failures
    runs-on: self-hosted
    needs: [build-hardened-apache, build-minimal-apache, build-hardened-docker, build-minimal-docker, build-hardened-mysql, build-minimal-mysql, build-hardened-tomcat, build-minimal-tomcat]
    if: |
      always() && (
        needs.build-hardened-apache.result == 'failure' ||
        needs.build-minimal-apache.result == 'failure' ||
        needs.build-hardened-docker.result == 'failure' ||
        needs.build-minimal-docker.result == 'failure' ||
        needs.build-hardened-mysql.result == 'failure' ||
        needs.build-minimal-mysql.result == 'failure' ||
        needs.build-hardened-tomcat.result == 'failure' ||
        needs.build-minimal-tomcat.result == 'failure'
      )
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: Setup Python for Claude API
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Anthropic SDK
        run: pip install anthropic

      - name: Analyze failures and create fix with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_RESULTS: |
            Hardened Apache: ${{ needs.build-hardened-apache.result }}
            Minimal Apache: ${{ needs.build-minimal-apache.result }}
            Hardened Docker: ${{ needs.build-hardened-docker.result }}
            Minimal Docker: ${{ needs.build-minimal-docker.result }}
            Hardened MySQL: ${{ needs.build-hardened-mysql.result }}
            Minimal MySQL: ${{ needs.build-minimal-mysql.result }}
            Hardened Tomcat: ${{ needs.build-hardened-tomcat.result }}
            Minimal Tomcat: ${{ needs.build-minimal-tomcat.result }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess
          from anthropic import Anthropic
          from pathlib import Path
          
          # Initialize Claude client
          client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          
          # Collect error logs
          artifacts_path = Path('artifacts')
          error_logs = []
          
          if artifacts_path.exists():
              for log_dir in artifacts_path.glob('packer-logs-*'):
                  for log_file in log_dir.glob('*.log'):
                      try:
                          content = log_file.read_text()
                          error_logs.append(f"\\n=== {log_file.name} ===\\n{content[-5000:]}")  # Last 5000 chars
                      except Exception as e:
                          print(f"Error reading {log_file}: {e}")
          
          # Prepare context
          context = f\"\"\"
          Debian 12 Packer Build Failure Analysis
          
          Build Results:
          {os.environ.get('BUILD_RESULTS', 'No results available')}
          
          Error Logs:
          {''.join(error_logs) if error_logs else 'No log files found'}
          
          Repository Architecture:
          - builds/proxmox/linux/debian/12/hardened/ - HCL configs for hardened builds
          - builds/proxmox/linux/debian/12/minimal/ - HCL configs for minimal builds
          - builds/proxmox/ansible/ - Ansible playbooks for provisioning
          - .github/workflows/ - CI workflow definitions
          
          Build Architecture:
          - Base template VM (ID 9000) must exist before running
          - 8 sequential builds: 4 hardened + 4 minimal variants
          - Roles: apache, docker, mysql, tomcat
          - Uses proxmox-clone builder with ansible-local provisioner
          - Each build creates VMs 9001-9008
          
          Common failure patterns:
          - VM ID conflicts (handled with continue-on-error logic)
          - Ansible provisioning errors (syntax, task failures)
          - SSH connection timeouts or authentication issues
          - Package installation failures in Ansible
          - Proxmox API authentication or connectivity problems
          - Resource allocation issues (CPU, RAM, disk)
          - Cloud-init not completing in time
          
          Task:
          Analyze the build failures and provide:
          1. Root cause analysis of each failure
          2. Specific file paths and line numbers that need changes
          3. Exact code changes needed to fix the issues
          4. Explanation of why these changes resolve the problems
          5. Step-by-step remediation plan
          \"\"\"
          
          # Call Claude API
          try:
              message = client.messages.create(
                  model="claude-sonnet-4-20250514",
                  max_tokens=4096,
                  messages=[{
                      "role": "user",
                      "content": context
                  }]
              )
              
              analysis = message.content[0].text
              
              # Save analysis to file
              with open('claude_analysis.md', 'w') as f:
                  f.write("# CI Failure Analysis by Claude\\n\\n")
                  f.write(analysis)
              
              print("\\n=== Claude Analysis ===")
              print(analysis)
              print("\\n=== Analysis saved to claude_analysis.md ===")
              
              # Create issue with analysis
              issue_body = f\"\"\"
          ## Automated CI Failure Analysis
          
          **Workflow Run:** ${{{{ github.server_url }}}}/${{{{ github.repository }}}}/actions/runs/${{{{ github.run_id }}}}
          
          ### Build Results
          {os.environ.get('BUILD_RESULTS', 'No results available')}
          
          ### Claude AI Analysis
          
          {analysis}
          
          ---
          *This analysis was automatically generated by Claude AI (claude-sonnet-4-20250514)*
          *Review the attached artifacts for complete build logs*
          \"\"\"
              
              # Create GitHub issue using gh CLI
              subprocess.run([
                  'gh', 'issue', 'create',
                  '--title', f'CI Failure: Debian 12 Build (Run #{os.environ.get("GITHUB_RUN_NUMBER", "unknown")})',
                  '--body', issue_body,
                  '--label', 'ci-failure,automated'
              ], check=True)
              
              print("\\n=== GitHub issue created successfully ===")
              
          except Exception as e:
              print(f"Error calling Claude API or creating issue: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          
          PYTHON_SCRIPT

      - name: Upload Claude analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-analysis
          path: claude_analysis.md
          retention-days: 30
